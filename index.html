<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quantum Kaleidoscope</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
    
    #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    
    #controls {
      position: fixed; left: 15px; top: 50%; transform: translateY(-50%);
      background: rgba(0,0,0,0.9); padding: 15px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15); width: 240px;
      max-height: 90vh; overflow-y: auto; z-index: 100;
      transition: transform 0.3s, opacity 0.3s;
    }
    #controls.hidden { transform: translateY(-50%) translateX(-280px); opacity: 0; pointer-events: none; }
    #controls::-webkit-scrollbar { width: 4px; }
    #controls::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    
    #controls h2 { color: rgba(255,255,255,0.95); font-size: 16px; font-weight: 400; margin-bottom: 12px; text-align: center; }
    
    .section { border-top: 1px solid rgba(255,255,255,0.1); margin-top: 12px; padding-top: 10px; }
    .section-title { color: rgba(255,255,255,0.5); font-size: 9px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    
    .control-group { margin-bottom: 10px; }
    .control-group label { display: block; color: rgba(255,255,255,0.7); font-size: 10px; margin-bottom: 4px; }
    .control-group input[type="range"] { width: 100%; height: 5px; -webkit-appearance: none; background: rgba(255,255,255,0.15); border-radius: 3px; }
    .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #9b5de5; border-radius: 50%; cursor: pointer; }
    
    .btn { width: 100%; padding: 8px; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.9); font-size: 11px; cursor: pointer; margin-bottom: 5px; transition: background 0.2s; }
    .btn:hover { background: rgba(255,255,255,0.2); }
    .btn.active { background: rgba(155,93,229,0.5); border: 1px solid rgba(155,93,229,0.8); }
    
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .btn-small { padding: 6px; font-size: 10px; }
    
    .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .color-btn { height: 20px; border: none; border-radius: 4px; cursor: pointer; transition: transform 0.15s; }
    .color-btn:hover { transform: scale(1.1); }
    .color-btn.active { box-shadow: 0 0 0 2px white; }
    
    select { width: 100%; padding: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: white; font-size: 11px; }
    select option { background: #1a1a2e; }
    
    #toggleBtn { position: fixed; top: 15px; right: 15px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; cursor: pointer; z-index: 101; display: flex; align-items: center; justify-content: center; }
    #toggleBtn:hover { background: rgba(255,255,255,0.2); }
    #toggleBtn svg { width: 20px; height: 20px; fill: rgba(255,255,255,0.8); }
    
    #sessionTimer { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.4); font-size: 18px; font-weight: 300; z-index: 1001; opacity: 0; transition: opacity 0.5s; letter-spacing: 2px; }
    #sessionTimer.visible { opacity: 1; }
    
    #phaseIndicator { position: fixed; top: 45px; left: 50%; transform: translateX(-50%); color: rgba(155,93,229,0.6); font-size: 11px; z-index: 1001; opacity: 0; transition: opacity 0.5s; letter-spacing: 2px; text-transform: uppercase; }
    #phaseIndicator.visible { opacity: 1; }
    
    #breathingPacer { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 600; opacity: 0; transition: opacity 1s; }
    #breathingPacer.visible { opacity: 1; }
    
    #keyboardHint { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.2); font-size: 9px; z-index: 100; letter-spacing: 1px; }
  </style>
</head>
<body>
  <div id="sessionTimer">00:00</div>
  <div id="phaseIndicator">Relaxation</div>
  <canvas id="breathingPacer" width="400" height="400"></canvas>
  <div id="keyboardHint">Space: Pause | F: Fullscreen | B: Breathing | ‚Üê‚Üí: Speed</div>
  
  <canvas id="canvas"></canvas>
  
  <div id="warningModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="background:#1a1a2e; padding:30px 40px; border-radius:16px; max-width:500px; text-align:center; border:2px solid #9b5de5;">
      <div style="font-size:48px; margin-bottom:15px;">‚ö†Ô∏è</div>
      <h2 style="color:#fff; margin:0 0 15px 0; font-size:22px;">Photosensitivity Warning</h2>
      <p style="color:#ccc; line-height:1.6; margin-bottom:20px;">
        This application contains <strong style="color:#ff6b6b;">flashing lights, pulsing patterns, and stroboscopic effects</strong> that may trigger seizures in people with photosensitive epilepsy.
      </p>
      <p style="color:#aaa; font-size:14px; margin-bottom:25px;">
        If you or anyone in your family has a history of seizures or epilepsy, consult a doctor before use. Stop immediately if you experience dizziness, altered vision, eye or muscle twitches, disorientation, or involuntary movements.
      </p>
      <button id="warningAccept" style="background:linear-gradient(135deg,#9b5de5,#7b2cbf); color:#fff; border:none; padding:14px 40px; font-size:16px; border-radius:8px; cursor:pointer; font-weight:600;">I Understand</button>
    </div>
  </div>
  
  <button id="toggleBtn">
    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
  </button>
  
  <div id="controls">
    <h2>‚ú¶ Quantum Kaleidoscope</h2>
    
    <div class="section-title">üöÄ Journey Presets</div>
    <div class="btn-grid">
      <button class="btn btn-small" id="journeyQuick">‚ö° Quick<br><span style="font-size:8px;opacity:0.6">5 min</span></button>
      <button class="btn btn-small" id="journeyDeep">üåä Deep<br><span style="font-size:8px;opacity:0.6">20 min</span></button>
      <button class="btn btn-small" id="journeyGamma">üß† Gamma<br><span style="font-size:8px;opacity:0.6">10 min</span></button>
      <button class="btn btn-small" id="journeyPsych">üåà Psychedelic<br><span style="font-size:8px;opacity:0.6">15 min</span></button>
    </div>
    <button class="btn" id="stopJourneyBtn" style="display:none; background: #8b2942;">‚èπ Stop Journey</button>
    
    <button class="btn" id="pauseBtn">‚è∏ Pause</button>
    <button class="btn" id="fullscreenBtn">‚õ∂ Fullscreen</button>
    <button class="btn" id="tranceBtn">üßø Deep Trance Mode</button>
    
    <div class="section">
      <div class="section-title">‚öôÔ∏è Controls</div>
      <div class="control-group">
        <label>Symmetry: <span id="segVal">12</span></label>
        <input type="range" id="segments" min="4" max="24" value="12">
      </div>
      <div class="control-group">
        <label>Speed: <span id="speedVal">0.5</span>x</label>
        <input type="range" id="speed" min="0.05" max="2" step="0.05" value="0.5">
      </div>
      <div class="control-group">
        <label>Center Depth: <span id="depthVal">300</span>%</label>
        <input type="range" id="centerDepth" min="50" max="800" value="300">
      </div>
      <div class="control-group">
        <label>Vignette: <span id="vigVal">40</span>%</label>
        <input type="range" id="vignette" min="0" max="100" value="40">
      </div>
      <div class="control-group">
        <label>Mutation: <span id="mutVal">100</span>%</label>
        <input type="range" id="mutation" min="20" max="300" value="100">
      </div>
      <div class="control-group">
        <label>Color Theme</label>
        <div class="color-grid" id="colorGrid"></div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">ü´Å Breathing</div>
      <div class="control-group">
        <label>Mode</label>
        <select id="breathMode">
          <option value="normal">Normal (Adjustable)</option>
          <option value="box">Box (4-4-4-4)</option>
          <option value="478">4-7-8 Relaxing</option>
          <option value="coherence">Heart Coherence</option>
        </select>
      </div>
      <div class="control-group">
        <label>Rate: <span id="breathVal">6</span> BPM</label>
        <input type="range" id="breathRate" min="3" max="10" value="6">
      </div>
      <button class="btn" id="breathToggle">ü´Å Show Pacer</button>
    </div>
    
    <div class="section">
      <div class="section-title">üß† Gamma (40Hz)</div>
      <div class="control-group">
        <label>Type</label>
        <select id="gammaType">
          <option value="subtle">Subtle (Movement)</option>
          <option value="moderate">Moderate (Pulse)</option>
          <option value="intense">Intense (Flicker)</option>
        </select>
      </div>
      <div class="control-group">
        <label>Intensity: <span id="gammaVal">0</span>%</label>
        <input type="range" id="gammaInt" min="0" max="100" value="0">
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">‚è±Ô∏è Session</div>
      <div class="btn-grid">
        <button class="btn btn-small" id="sess5">5m</button>
        <button class="btn btn-small" id="sess10">10m</button>
        <button class="btn btn-small" id="sess20">20m</button>
        <button class="btn btn-small" id="sessStop">‚èπ Stop</button>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">üîä Audio & Binaural</div>
      <button class="btn" id="audioBtn">üé§ Enable Audio Input</button>
      <div class="control-group">
        <label>Audio Sensitivity: <span id="audioSensVal">100</span>%</label>
        <input type="range" id="audioSens" min="20" max="300" value="100">
      </div>
      <button class="btn" id="binauralBtn">üîä Play 40Hz Gamma Tone</button>
      <button class="btn" id="binauralTrueBtn">üéß True Binaural (Headphones)</button>
      <div class="control-group">
        <label>Tone Volume: <span id="toneVolVal">50</span>%</label>
        <input type="range" id="toneVol" min="0" max="100" value="50">
      </div>
      <input type="file" id="audioUpload" accept="audio/*" style="display:none;">
      <button class="btn" id="audioUploadBtn">üìÇ Load Music File</button>
      <button class="btn" id="audioPlayBtn" style="display:none;">‚ñ∂ Play Audio</button>
    </div>
    
    <div class="section">
      <button class="btn" id="shuffleBtn">üîÄ Shuffle</button>
    </div>
  </div>

  <script>
    const settings = {
      segments: 12, speed: 0.5, colorScheme: 'kaleidoscope', isPaused: false,
      breathRate: 6, drift: 0.3, vignette: 0.4,
      centerDepth: 3.0, mutationRate: 1.0, tranceMode: false,
      gammaType: 'subtle', gammaIntensity: 0, breathingMode: 'normal',
      showBreathing: false, sessionActive: false, sessionDuration: 0, sessionStartTime: 0,
      audioEnabled: false, audioSensitivity: 1.0, binauralPlaying: false,
      trueBinauralPlaying: false, toneVolume: 0.5
    };
    
    let audioContext = null, analyser = null, microphone = null;
    let binauralOsc = null, binauralGain = null;
    let binauralLeft = null, binauralRight = null;
    let uploadedAudio = null, uploadedSource = null;
    let audioData = { bass: 0, mid: 0, high: 0, volume: 0, raw: null };
    
    let globalColorPhase = 0, globalBreathPhase = 0, globalGammaPulse = 0, time = 0;
    const pieces = [];
    const MAX_PIECES = 120;
    
    const colorSchemes = {
      kaleidoscope: ['#C0392B', '#27AE60', '#D4AC0D', '#2980B9', '#8E44AD', '#1ABC9C', '#E67E22', '#2471A3', '#A8D600', '#E74C3C', '#17A589', '#9B59B6'],
      jewels: ['#C0392B', '#2980B9', '#27AE60', '#D4AC0D', '#8E44AD', '#16A085', '#E67E22', '#2C3E50', '#1ABC9C', '#E74C3C', '#3498DB', '#9B59B6'],
      neon: ['#E91E63', '#00BCD4', '#FFEB3B', '#F44336', '#4CAF50', '#2196F3', '#FF9800', '#00E676', '#9C27B0', '#FF5722', '#8BC34A', '#03A9F4'],
      ocean: ['#1A5276', '#2471A3', '#2E86C1', '#3498DB', '#5DADE2', '#85C1E9', '#1ABC9C', '#16A085', '#117A65', '#148F77', '#17A589', '#1ABC9C'],
      sunset: ['#922B21', '#C0392B', '#E74C3C', '#EC7063', '#E67E22', '#F39C12', '#F1C40F', '#D35400', '#CA6F1E', '#BA4A00', '#A04000', '#873600'],
      forest: ['#1E8449', '#229954', '#27AE60', '#2ECC71', '#58D68D', '#82E0AA', '#117A65', '#148F77', '#16A085', '#17A589', '#1ABC9C', '#48C9B0']
    };
    
    const journeys = {
      quick: { dur: 5, speed: 0.5, segments: 10, depth: 2.5, gamma: 20 },
      deep: { dur: 20, speed: 0.2, segments: 8, depth: 5.0, gamma: 40 },
      gamma: { dur: 10, speed: 0.4, segments: 12, depth: 3.0, gamma: 60 },
      psych: { dur: 15, speed: 1.0, segments: 16, depth: 4.0, gamma: 30 }
    };
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    function resize() {
      canvas.width = window.innerWidth || 800;
      canvas.height = window.innerHeight || 600;
    }
    resize();
    window.addEventListener('resize', resize);
    
    function createPiece(forceNew = false) {
      const ringChoice = Math.random();
      let r, minR, maxR;
      if (ringChoice < 0.33) { minR = 0.15; maxR = 0.34; }
      else if (ringChoice < 0.66) { minR = 0.36; maxR = 0.64; }
      else { minR = 0.66; maxR = 0.88; }
      r = minR + Math.random() * (maxR - minR);
      const segWidth = (Math.PI * 2) / settings.segments;
      const angle = (Math.random() - 0.5) * segWidth * 0.95;
      const sizeRand = Math.random();
      let size = sizeRand < 0.4 ? 0.02 + Math.random() * 0.025 : sizeRand < 0.8 ? 0.04 + Math.random() * 0.04 : 0.06 + Math.random() * 0.05;
      return {
        id: Math.random(), r, angle, size, minR, maxR,
        rotation: Math.random() * Math.PI * 2,
        rotationSpeed: (Math.random() - 0.5) * 3.0,
        shape: Math.floor(Math.random() * 8),
        colorOffset: Math.random(),
        rVel: (Math.random() - 0.5) * 0.006,
        angleVel: (Math.random() - 0.5) * 0.01,
        born: time,
        lifespan: (12 + Math.random() * 20) / settings.mutationRate,
        fadeIn: forceNew ? 0 : 1, fadeOut: 1,
        wobblePhase: Math.random() * Math.PI * 2,
        wobbleSpeed: 1.0 + Math.random() * 2.0,
        wobbleAmount: 0.01 + Math.random() * 0.02
      };
    }
    
    for (let i = 0; i < MAX_PIECES; i++) pieces.push(createPiece(false));
    
    function getBreathState() {
      const now = Date.now() / 1000;
      let phase = 0, instruction = '';
      if (settings.breathingMode === 'box') {
        const cycleTime = now % 16;
        if (cycleTime < 4) { phase = cycleTime / 16; instruction = 'Breathe In'; }
        else if (cycleTime < 8) { phase = cycleTime / 16; instruction = 'Hold'; }
        else if (cycleTime < 12) { phase = cycleTime / 16; instruction = 'Breathe Out'; }
        else { phase = cycleTime / 16; instruction = 'Hold'; }
      } else if (settings.breathingMode === '478') {
        const cycleTime = now % 19;
        if (cycleTime < 4) { phase = cycleTime / 19; instruction = 'In (4)'; }
        else if (cycleTime < 11) { phase = cycleTime / 19; instruction = 'Hold (7)'; }
        else { phase = cycleTime / 19; instruction = 'Out (8)'; }
      } else if (settings.breathingMode === 'coherence') {
        const cycleTime = now % 10;
        phase = cycleTime / 10;
        instruction = cycleTime < 5 ? 'Breathe In' : 'Breathe Out';
      } else {
        const cycleDur = 60 / settings.breathRate;
        const cycleTime = now % cycleDur;
        phase = cycleTime / cycleDur;
        instruction = phase < 0.5 ? 'Breathe In' : 'Breathe Out';
      }
      return { phase, instruction };
    }
    
    function updatePieces() {
      const baseDt = 0.016, dt = baseDt * settings.speed;
      globalColorPhase += dt * 0.03;
      const breathState = getBreathState();
      globalBreathPhase = breathState.phase;
      globalGammaPulse = Math.sin(Date.now() / 1000 * 40 * Math.PI * 2) * 0.5 + 0.5;
      for (let i = pieces.length - 1; i >= 0; i--) {
        const p = pieces[i];
        const age = time - p.born, lifeRatio = age / p.lifespan;
        if (p.fadeIn < 1) p.fadeIn = Math.min(1, p.fadeIn + baseDt * 0.8);
        if (lifeRatio > 0.7) p.fadeOut = 1 - ((lifeRatio - 0.7) / 0.3);
        if (lifeRatio > 1 || p.fadeOut < 0.01) { pieces.splice(i, 1); continue; }
        const breathInf = globalBreathPhase > 0.5 ? 1.1 : 1.0;
        p.r += p.rVel * dt * 3 * breathInf;
        p.angle += p.angleVel * dt * 3 * breathInf;
        p.wobblePhase += p.wobbleSpeed * dt * 0.2;
        p.rotation += p.rotationSpeed * dt * 1.5;
        if (p.r < p.minR) { p.rVel = Math.abs(p.rVel); p.r = p.minR; }
        if (p.r > p.maxR) { p.rVel = -Math.abs(p.rVel); p.r = p.maxR; }
        const segWidth = (Math.PI * 2) / settings.segments, maxAngle = segWidth * 0.48;
        if (Math.abs(p.angle) > maxAngle) { p.angleVel *= -1; p.angle = Math.sign(p.angle) * maxAngle; }
        p.rVel += (Math.random() - 0.5) * 0.0003;
        p.angleVel += (Math.random() - 0.5) * 0.0006;
        p.rVel = Math.max(-0.008, Math.min(0.008, p.rVel));
        p.angleVel = Math.max(-0.012, Math.min(0.012, p.angleVel));
        p.colorOffset += dt * 0.03;
      }
      while (pieces.length < MAX_PIECES) pieces.push(createPiece(true));
    }
    
    function getColor(t) {
      const colors = colorSchemes[settings.colorScheme];
      const idx = Math.floor(((t % 1) + 1) % 1 * colors.length) % colors.length;
      return colors[idx];
    }
    
    function drawPiece(ctx, x, y, size, rotation, shape, color, alpha) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation);
      ctx.globalAlpha = alpha;
      const r = parseInt(color.slice(1,3), 16), g = parseInt(color.slice(3,5), 16), b = parseInt(color.slice(5,7), 16);
      ctx.beginPath();
      switch(shape % 8) {
        case 0: ctx.moveTo(0, -size); ctx.lineTo(size * 0.8, size * 0.6); ctx.lineTo(-size * 0.7, size * 0.5); break;
        case 1: ctx.moveTo(0, -size * 1.1); ctx.lineTo(size * 0.6, 0); ctx.lineTo(0, size * 1.1); ctx.lineTo(-size * 0.6, 0); break;
        case 2: ctx.ellipse(0, 0, size, size * 0.6, 0, 0, Math.PI * 2); break;
        case 3: ctx.arc(0, 0, size * 0.7, 0, Math.PI * 2); break;
        case 4: ctx.moveTo(-size * 0.5, -size * 0.7); ctx.lineTo(size * 0.7, -size * 0.4); ctx.lineTo(size * 0.5, size * 0.8); ctx.lineTo(-size * 0.8, size * 0.5); break;
        case 5: for (let i = 0; i < 6; i++) { const a = (i / 6) * Math.PI * 2 - Math.PI / 2; if (i === 0) ctx.moveTo(Math.cos(a) * size * 0.8, Math.sin(a) * size * 0.8); else ctx.lineTo(Math.cos(a) * size * 0.8, Math.sin(a) * size * 0.8); } break;
        case 6: ctx.ellipse(0, 0, size * 0.35, size * 1.2, 0, 0, Math.PI * 2); break;
        case 7: ctx.moveTo(-size * 0.4, -size * 0.6); ctx.lineTo(size * 0.5, -size * 0.5); ctx.lineTo(size * 0.7, size * 0.6); ctx.lineTo(-size * 0.6, size * 0.5); break;
      }
      ctx.closePath();
      const grad = ctx.createLinearGradient(-size, -size, size * 0.5, size * 0.5);
      grad.addColorStop(0, 'rgb(' + Math.min(255, r + 40) + ',' + Math.min(255, g + 40) + ',' + Math.min(255, b + 40) + ')');
      grad.addColorStop(0.5, 'rgb(' + r + ',' + g + ',' + b + ')');
      grad.addColorStop(1, 'rgb(' + Math.max(0, r - 30) + ',' + Math.max(0, g - 30) + ',' + Math.max(0, b - 30) + ')');
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,0.3)';
      ctx.lineWidth = 1;
      ctx.stroke();
      ctx.restore();
    }
    
    function drawKaleidoscope(cx, cy, maxR) {
      const segWidth = (Math.PI * 2) / settings.segments;
      const rings = [
        { minR: 0, maxR: 0.35, rotSpeed: 0.15, dir: 1 },
        { minR: 0.35, maxR: 0.65, rotSpeed: 0.08, dir: -1 },
        { minR: 0.65, maxR: 1.0, rotSpeed: 0.03, dir: 1 }
      ];
      const gammaPulse = settings.gammaIntensity > 0 ? globalGammaPulse * (settings.gammaIntensity / 100) * 0.15 : 0;
      const ringPieces = [[], [], []];
      for (const p of pieces) {
        if (p.maxR <= 0.35) ringPieces[0].push(p);
        else if (p.maxR <= 0.65) ringPieces[1].push(p);
        else ringPieces[2].push(p);
      }
      rings.forEach((ring, ringIdx) => {
        const ringRotation = time * ring.rotSpeed * ring.dir;
        const piecesInRing = ringPieces[ringIdx];
        for (let i = 0; i < settings.segments; i++) {
          const segAngle = (i / settings.segments) * Math.PI * 2 + ringRotation;
          const mirrored = i % 2 === 1;
          ctx.save();
          ctx.translate(cx, cy);
          ctx.rotate(segAngle);
          if (mirrored) ctx.scale(1, -1);
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.arc(0, 0, maxR, -segWidth / 2, segWidth / 2);
          ctx.closePath();
          ctx.clip();
          for (const p of piecesInRing) {
            let alpha = p.fadeIn * (p.fadeOut || 1) * (1 + gammaPulse);
            if (alpha < 0.03) continue;
            const wobbleR = Math.sin(p.wobblePhase) * p.wobbleAmount;
            const wobbleA = Math.cos(p.wobblePhase * 0.7) * p.wobbleAmount * 0.5;
            const r = maxR * (p.r + wobbleR);
            const a = p.angle + wobbleA;
            if (Math.abs(a) > segWidth / 2) continue;
            const x = Math.cos(a) * r, y = Math.sin(a) * r;
            const breathSize = 1 + (globalBreathPhase > 0.5 ? 0.05 : -0.03);
            const gammaSize = 1 + gammaPulse * 0.1;
            const sizeScale = 0.6 + p.r * 0.6;
            const size = maxR * p.size * sizeScale * breathSize * gammaSize;
            const colorT = ((p.colorOffset + globalColorPhase) * 2.0) % 1;
            drawPiece(ctx, x, y, size, p.rotation, p.shape, getColor(colorT), alpha);
          }
          ctx.restore();
        }
      });
    }
    
    function drawCenter(cx, cy, maxR) {
      let breathDepth = globalBreathPhase < 0.5 ? globalBreathPhase * 2 : 1 - (globalBreathPhase - 0.5) * 2;
      let ease = breathDepth < 0.5 ? 2 * breathDepth * breathDepth : 1 - Math.pow(-2 * breathDepth + 2, 2) / 2;
      if (settings.audioEnabled && audioData.bass > 0) ease = Math.min(1, ease + audioData.bass * 0.4);
      const depthMult = settings.centerDepth;
      const numRings = Math.floor(12 + depthMult * 6);
      const maxTunnel = maxR * 0.25 * depthMult;
      let gammaPulse = settings.gammaIntensity > 0 ? globalGammaPulse * (settings.gammaIntensity / 100) * 0.3 : 0;
      for (let i = 0; i < numRings; i++) {
        const progress = i / (numRings - 1);
        const ringSize = 2 + (maxTunnel - 2) * Math.pow(progress, 0.6) * ease;
        if (ringSize < 0.5) continue;
        const baseAlpha = 0.15 + progress * 0.5;
        const depthAlpha = 0.3 + ease * 0.7;
        const gammaAlpha = 1 + gammaPulse * (1 - progress);
        const ringAlpha = baseAlpha * depthAlpha * gammaAlpha;
        const thickness = 1.5 + progress * ease * 6;
        ctx.beginPath();
        ctx.arc(cx, cy, ringSize, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255,255,255,' + ringAlpha + ')';
        ctx.lineWidth = thickness;
        ctx.stroke();
      }
      const dotSize = 2 + ease * 12;
      const bright = 0.4 + ease * 0.6 + gammaPulse * 0.2;
      const glow = ctx.createRadialGradient(cx, cy, 0, cx, cy, dotSize * 6);
      glow.addColorStop(0, 'rgba(255,255,255,' + bright + ')');
      glow.addColorStop(0.2, 'rgba(255,255,255,' + (bright * 0.5) + ')');
      glow.addColorStop(0.5, 'rgba(255,255,255,' + (bright * 0.15) + ')');
      glow.addColorStop(1, 'rgba(255,255,255,0)');
      ctx.fillStyle = glow;
      ctx.beginPath();
      ctx.arc(cx, cy, dotSize * 6, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(cx, cy, dotSize, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,' + Math.min(1, bright * 1.2) + ')';
      ctx.fill();
    }
    
    function drawBreathingPacer() {
      if (!settings.showBreathing || settings.isPaused) return;
      const pCanvas = document.getElementById('breathingPacer');
      const pCtx = pCanvas.getContext('2d');
      const size = 400, cx = size / 2, cy = size / 2;
      pCtx.clearRect(0, 0, size, size);
      const breathState = getBreathState();
      let breathSize = breathState.phase < 0.5 ? breathState.phase * 2 : 1 - (breathState.phase - 0.5) * 2;
      breathSize = breathSize < 0.5 ? 2 * breathSize * breathSize : 1 - Math.pow(-2 * breathSize + 2, 2) / 2;
      const minR = 50, maxR = 160;
      const radius = minR + (maxR - minR) * breathSize;
      pCtx.strokeStyle = 'rgba(255,255,255,0.3)';
      pCtx.lineWidth = 3;
      pCtx.beginPath();
      pCtx.arc(cx, cy, radius, 0, Math.PI * 2);
      pCtx.stroke();
      const grad = pCtx.createRadialGradient(cx, cy, radius * 0.8, cx, cy, radius);
      grad.addColorStop(0, 'rgba(255,255,255,0)');
      grad.addColorStop(1, 'rgba(255,255,255,0.1)');
      pCtx.fillStyle = grad;
      pCtx.beginPath();
      pCtx.arc(cx, cy, radius, 0, Math.PI * 2);
      pCtx.fill();
      pCtx.fillStyle = 'rgba(255,255,255,0.9)';
      pCtx.font = 'bold 28px sans-serif';
      pCtx.textAlign = 'center';
      pCtx.textBaseline = 'middle';
      pCtx.shadowColor = 'rgba(155, 93, 229, 0.8)';
      pCtx.shadowBlur = 15;
      pCtx.fillText(breathState.instruction, cx, cy);
      pCtx.shadowBlur = 0;
      pCtx.font = '14px sans-serif';
      pCtx.fillStyle = 'rgba(255,255,255,0.4)';
      pCtx.fillText(settings.breathingMode === 'normal' ? settings.breathRate + ' BPM' : settings.breathingMode.toUpperCase(), cx, cy + radius + 35);
    }
    
    function drawGammaFlicker(cx, cy, maxR) {
      if (settings.gammaType === 'subtle' || settings.gammaIntensity === 0) return;
      const flicker = Math.sin(Date.now() / 1000 * 40 * Math.PI * 2) * 0.5 + 0.5;
      const intensity = settings.gammaIntensity / 100;
      if (settings.gammaType === 'moderate') {
        const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.5);
        grad.addColorStop(0, 'rgba(255,255,255,' + (flicker * intensity * 0.15) + ')');
        grad.addColorStop(0.5, 'rgba(255,255,255,' + (flicker * intensity * 0.05) + ')');
        grad.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(cx, cy, maxR * 0.5, 0, Math.PI * 2);
        ctx.fill();
      } else if (settings.gammaType === 'intense') {
        ctx.fillStyle = 'rgba(255,255,255,' + (flicker * intensity * 0.1) + ')';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }
    
    function updateSession() {
      if (!settings.sessionActive) return;
      const elapsed = Date.now() - settings.sessionStartTime;
      const remaining = settings.sessionDuration - elapsed;
      const mins = Math.floor(Math.max(0, remaining) / 60000);
      const secs = Math.floor((Math.max(0, remaining) % 60000) / 1000);
      document.getElementById('sessionTimer').textContent = String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
      const progress = elapsed / settings.sessionDuration;
      let phase = progress < 0.2 ? 'Relaxation' : progress < 0.5 ? 'Focus' : progress < 0.85 ? 'Deep State' : 'Integration';
      document.getElementById('phaseIndicator').textContent = phase;
      if (remaining <= 0) stopSession();
    }
    
    function startSession(mins) {
      settings.sessionActive = true;
      settings.sessionDuration = mins * 60 * 1000;
      settings.sessionStartTime = Date.now();
      document.getElementById('sessionTimer').classList.add('visible');
      document.getElementById('phaseIndicator').classList.add('visible');
      document.getElementById('stopJourneyBtn').style.display = 'block';
    }
    
    function stopSession() {
      settings.sessionActive = false;
      document.getElementById('sessionTimer').classList.remove('visible');
      document.getElementById('phaseIndicator').classList.remove('visible');
      document.getElementById('stopJourneyBtn').style.display = 'none';
    }
    
    function applyJourney(key) {
      const j = journeys[key];
      settings.speed = j.speed;
      settings.segments = j.segments;
      settings.centerDepth = j.depth;
      settings.gammaIntensity = j.gamma;
      pieces.length = 0;
      for (let i = 0; i < MAX_PIECES; i++) pieces.push(createPiece(false));
      document.getElementById('speed').value = j.speed;
      document.getElementById('speedVal').textContent = j.speed.toFixed(2);
      document.getElementById('segments').value = j.segments;
      document.getElementById('segVal').textContent = j.segments;
      document.getElementById('centerDepth').value = j.depth * 100;
      document.getElementById('depthVal').textContent = Math.round(j.depth * 100);
      document.getElementById('gammaInt').value = j.gamma;
      document.getElementById('gammaVal').textContent = j.gamma;
      startSession(j.dur);
    }
    
    async function initAudio() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.8;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        audioData.raw = new Uint8Array(analyser.frequencyBinCount);
        settings.audioEnabled = true;
        document.getElementById('audioBtn').textContent = 'üé§ Audio ON';
        document.getElementById('audioBtn').classList.add('active');
      } catch (err) { alert('Could not access microphone.'); }
    }
    
    function stopAudio() {
      if (microphone) { microphone.disconnect(); microphone = null; }
      settings.audioEnabled = false;
      document.getElementById('audioBtn').textContent = 'üé§ Enable Audio Input';
      document.getElementById('audioBtn').classList.remove('active');
    }
    
    function analyzeAudio() {
      if (!analyser || !audioData.raw) return;
      try {
        analyser.getByteFrequencyData(audioData.raw);
        const bufLen = analyser.frequencyBinCount;
        const sampleRate = audioContext.sampleRate;
        const binSize = sampleRate / analyser.fftSize;
        let bassSum = 0, bassCount = 0, midSum = 0, midCount = 0, totalSum = 0;
        for (let i = 0; i < bufLen; i++) {
          const freq = i * binSize, val = audioData.raw[i] / 255;
          totalSum += val;
          if (freq >= 20 && freq <= 250) { bassSum += val; bassCount++; }
          else if (freq > 250 && freq <= 2000) { midSum += val; midCount++; }
        }
        const sens = settings.audioSensitivity;
        const newBass = bassCount > 0 ? (bassSum / bassCount) * sens : 0;
        const newMid = midCount > 0 ? (midSum / midCount) * sens : 0;
        const newVol = (totalSum / bufLen) * sens;
        audioData.bass = Math.min(1, audioData.bass * 0.7 + newBass * 0.3);
        audioData.mid = Math.min(1, audioData.mid * 0.7 + newMid * 0.3);
        audioData.volume = Math.min(1, audioData.volume * 0.7 + newVol * 0.3);
      } catch (err) { settings.audioEnabled = false; }
    }
    
    function startBinauralTone() {
      if (binauralOsc) { stopBinauralTone(); return; }
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioContext.resume();
      binauralOsc = audioContext.createOscillator();
      binauralOsc.frequency.value = 432;
      binauralOsc.type = 'sine';
      binauralGain = audioContext.createGain();
      binauralGain.gain.value = settings.toneVolume;
      binauralOsc.connect(binauralGain);
      binauralGain.connect(audioContext.destination);
      binauralOsc.start();
      settings.binauralPlaying = true;
      document.getElementById('binauralBtn').textContent = 'üîä PLAYING - Stop';
      document.getElementById('binauralBtn').classList.add('active');
      const pulse40Hz = () => {
        if (!settings.binauralPlaying || !binauralGain || !audioContext) return;
        try {
          const vol = settings.toneVolume, now = audioContext.currentTime;
          for (let i = 0; i < 40; i++) {
            const t = now + (i / 40);
            binauralGain.gain.setValueAtTime(vol, t);
            binauralGain.gain.setValueAtTime(vol * 0.05, t + 0.0125);
          }
          setTimeout(pulse40Hz, 950);
        } catch(e) {}
      };
      pulse40Hz();
    }
    
    function stopBinauralTone() {
      settings.binauralPlaying = false;
      if (binauralOsc) { try { binauralOsc.stop(); } catch(e) {} binauralOsc = null; }
      binauralGain = null;
      document.getElementById('binauralBtn').textContent = 'üîä Play 40Hz Gamma Tone';
      document.getElementById('binauralBtn').classList.remove('active');
    }
    
    function startTrueBinaural() {
      if (settings.trueBinauralPlaying) { stopTrueBinaural(); return; }
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioContext.resume();
      const leftOsc = audioContext.createOscillator();
      const rightOsc = audioContext.createOscillator();
      const leftPan = audioContext.createStereoPanner();
      const rightPan = audioContext.createStereoPanner();
      const leftGain = audioContext.createGain();
      const rightGain = audioContext.createGain();
      leftOsc.frequency.value = 200;
      rightOsc.frequency.value = 240;
      leftOsc.type = 'sine';
      rightOsc.type = 'sine';
      leftPan.pan.value = -1;
      rightPan.pan.value = 1;
      leftGain.gain.value = settings.toneVolume;
      rightGain.gain.value = settings.toneVolume;
      leftOsc.connect(leftGain);
      leftGain.connect(leftPan);
      leftPan.connect(audioContext.destination);
      rightOsc.connect(rightGain);
      rightGain.connect(rightPan);
      rightPan.connect(audioContext.destination);
      leftOsc.start();
      rightOsc.start();
      binauralLeft = { osc: leftOsc, gain: leftGain };
      binauralRight = { osc: rightOsc, gain: rightGain };
      settings.trueBinauralPlaying = true;
      document.getElementById('binauralTrueBtn').textContent = 'üéß Stop Binaural';
      document.getElementById('binauralTrueBtn').classList.add('active');
    }
    
    function stopTrueBinaural() {
      if (binauralLeft) { try { binauralLeft.osc.stop(); } catch(e) {} binauralLeft = null; }
      if (binauralRight) { try { binauralRight.osc.stop(); } catch(e) {} binauralRight = null; }
      settings.trueBinauralPlaying = false;
      document.getElementById('binauralTrueBtn').textContent = 'üéß True Binaural (Headphones)';
      document.getElementById('binauralTrueBtn').classList.remove('active');
    }
    
    function draw() {
      if (!settings.isPaused) { time += 0.016 * settings.speed; updatePieces(); }
      updateSession();
      drawBreathingPacer();
      if (settings.audioEnabled) analyzeAudio();
      const cx = canvas.width / 2, cy = canvas.height / 2;
      const maxR = Math.min(canvas.width, canvas.height) * 0.45;
      ctx.fillStyle = 'rgba(0,0,0,0.4)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(time * settings.drift * 0.01);
      ctx.scale(1 + Math.sin(time * 0.05) * settings.drift * 0.005, 1 + Math.sin(time * 0.05) * settings.drift * 0.005);
      ctx.translate(-cx, -cy);
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(cx, cy, maxR * 1.05, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
      drawKaleidoscope(cx, cy, maxR * 0.95);
      ctx.globalAlpha = 1;
      ctx.beginPath();
      ctx.arc(cx, cy, maxR, 0, Math.PI * 2);
      ctx.strokeStyle = '#1a1a1a';
      ctx.lineWidth = maxR * 0.05;
      ctx.stroke();
      ctx.restore();
      if (settings.vignette > 0) {
        const vig = ctx.createRadialGradient(cx, cy, maxR * 0.3, cx, cy, maxR * 1.4);
        vig.addColorStop(0, 'transparent');
        vig.addColorStop(0.5, 'transparent');
        vig.addColorStop(0.8, 'rgba(0,0,0,' + (settings.vignette * 0.5) + ')');
        vig.addColorStop(1, 'rgba(0,0,0,' + (settings.vignette * 0.9) + ')');
        ctx.fillStyle = vig;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      drawCenter(cx, cy, maxR);
      drawGammaFlicker(cx, cy, maxR);
      requestAnimationFrame(draw);
    }
    
    document.getElementById('toggleBtn').addEventListener('click', () => document.getElementById('controls').classList.toggle('hidden'));
    document.getElementById('warningAccept').addEventListener('click', function() { document.getElementById('warningModal').style.display = 'none'; });
    document.getElementById('pauseBtn').addEventListener('click', function() {
      settings.isPaused = !settings.isPaused;
      this.textContent = settings.isPaused ? '‚ñ∂ Play' : '‚è∏ Pause';
      this.classList.toggle('active', settings.isPaused);
    });
    document.getElementById('fullscreenBtn').addEventListener('click', function() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => { this.textContent = '‚õ∂ Exit Fullscreen'; this.classList.add('active'); }).catch(err => {});
      } else {
        document.exitFullscreen().then(() => { this.textContent = '‚õ∂ Fullscreen'; this.classList.remove('active'); });
      }
    });
    document.addEventListener('fullscreenchange', () => {
      const btn = document.getElementById('fullscreenBtn');
      if (!document.fullscreenElement) { btn.textContent = '‚õ∂ Fullscreen'; btn.classList.remove('active'); }
    });
    document.getElementById('journeyQuick').addEventListener('click', () => applyJourney('quick'));
    document.getElementById('journeyDeep').addEventListener('click', () => applyJourney('deep'));
    document.getElementById('journeyGamma').addEventListener('click', () => applyJourney('gamma'));
    document.getElementById('journeyPsych').addEventListener('click', () => applyJourney('psych'));
    document.getElementById('stopJourneyBtn').addEventListener('click', stopSession);
    document.getElementById('tranceBtn').addEventListener('click', function() {
      settings.tranceMode = !settings.tranceMode;
      this.classList.toggle('active', settings.tranceMode);
      this.textContent = settings.tranceMode ? 'üßø Trance ON' : 'üßø Deep Trance Mode';
      if (settings.tranceMode) {
        this._originalSettings = { speed: settings.speed, segments: settings.segments, breathRate: settings.breathRate, drift: settings.drift, vignette: settings.vignette, centerDepth: settings.centerDepth, mutationRate: settings.mutationRate, gammaIntensity: settings.gammaIntensity, showBreathing: settings.showBreathing };
        settings.speed = 0.15; settings.segments = 8; settings.breathRate = 5; settings.drift = 0.5; settings.vignette = 0.75; settings.centerDepth = 6.0; settings.mutationRate = 0.6; settings.gammaIntensity = 35; settings.showBreathing = true;
        pieces.length = 0; for (let i = 0; i < MAX_PIECES; i++) pieces.push(createPiece(false));
        document.getElementById('speed').value = 0.15; document.getElementById('speedVal').textContent = '0.15';
        document.getElementById('segments').value = 8; document.getElementById('segVal').textContent = '8';
        document.getElementById('breathRate').value = 5; document.getElementById('breathVal').textContent = '5';
        document.getElementById('vignette').value = 75; document.getElementById('vigVal').textContent = '75';
        document.getElementById('centerDepth').value = 600; document.getElementById('depthVal').textContent = '600';
        document.getElementById('mutation').value = 60; document.getElementById('mutVal').textContent = '60';
        document.getElementById('gammaInt').value = 35; document.getElementById('gammaVal').textContent = '35';
        document.getElementById('breathingPacer').classList.add('visible');
        document.getElementById('breathToggle').classList.add('active');
        document.getElementById('breathToggle').textContent = 'ü´Å Pacer ON';
      } else {
        const orig = this._originalSettings;
        if (orig) {
          settings.speed = orig.speed; settings.segments = orig.segments; settings.breathRate = orig.breathRate; settings.drift = orig.drift; settings.vignette = orig.vignette; settings.centerDepth = orig.centerDepth; settings.mutationRate = orig.mutationRate; settings.gammaIntensity = orig.gammaIntensity; settings.showBreathing = orig.showBreathing;
          pieces.length = 0; for (let i = 0; i < MAX_PIECES; i++) pieces.push(createPiece(false));
          document.getElementById('speed').value = orig.speed; document.getElementById('speedVal').textContent = orig.speed.toFixed(2);
          document.getElementById('segments').value = orig.segments; document.getElementById('segVal').textContent = orig.segments;
          document.getElementById('breathRate').value = orig.breathRate; document.getElementById('breathVal').textContent = orig.breathRate;
          document.getElementById('vignette').value = orig.vignette * 100; document.getElementById('vigVal').textContent = Math.round(orig.vignette * 100);
          document.getElementById('centerDepth').value = orig.centerDepth * 100; document.getElementById('depthVal').textContent = Math.round(orig.centerDepth * 100);
          document.getElementById('mutation').value = orig.mutationRate * 100; document.getElementById('mutVal').textContent = Math.round(orig.mutationRate * 100);
          document.getElementById('gammaInt').value = orig.gammaIntensity; document.getElementById('gammaVal').textContent = orig.gammaIntensity;
          document.getElementById('breathingPacer').classList.toggle('visible', orig.showBreathing);
          document.getElementById('breathToggle').classList.toggle('active', orig.showBreathing);
          document.getElementById('breathToggle').textContent = orig.showBreathing ? 'ü´Å Pacer ON' : 'ü´Å Show Pacer';
        }
      }
    });
    document.getElementById('segments').addEventListener('input', function() { settings.segments = parseInt(this.value); document.getElementById('segVal').textContent = this.value; pieces.length = 0; for (let i = 0; i < MAX_PIECES; i++) pieces.push(createPiece(false)); });
    document.getElementById('speed').addEventListener('input', function() { settings.speed = parseFloat(this.value); document.getElementById('speedVal').textContent = this.value; });
    document.getElementById('centerDepth').addEventListener('input', function() { settings.centerDepth = parseFloat(this.value) / 100; document.getElementById('depthVal').textContent = this.value; });
    document.getElementById('vignette').addEventListener('input', function() { settings.vignette = parseFloat(this.value) / 100; document.getElementById('vigVal').textContent = this.value; });
    document.getElementById('mutation').addEventListener('input', function() { settings.mutationRate = parseFloat(this.value) / 100; document.getElementById('mutVal').textContent = this.value; });
    document.getElementById('breathMode').addEventListener('change', function() { settings.breathingMode = this.value; });
    document.getElementById('breathRate').addEventListener('input', function() { settings.breathRate = parseFloat(this.value); document.getElementById('breathVal').textContent = this.value; });
    document.getElementById('breathToggle').addEventListener('click', function() { settings.showBreathing = !settings.showBreathing; document.getElementById('breathingPacer').classList.toggle('visible', settings.showBreathing); this.classList.toggle('active', settings.showBreathing); this.textContent = settings.showBreathing ? 'ü´Å Pacer ON' : 'ü´Å Show Pacer'; });
    document.getElementById('gammaType').addEventListener('change', function() { settings.gammaType = this.value; });
    document.getElementById('gammaInt').addEventListener('input', function() { settings.gammaIntensity = parseFloat(this.value); document.getElementById('gammaVal').textContent = this.value; });
    document.getElementById('sess5').addEventListener('click', () => startSession(5));
    document.getElementById('sess10').addEventListener('click', () => startSession(10));
    document.getElementById('sess20').addEventListener('click', () => startSession(20));
    document.getElementById('sessStop').addEventListener('click', () => { settings.sessionActive = false; document.getElementById('sessionTimer').classList.remove('visible'); document.getElementById('phaseIndicator').classList.remove('visible'); });
    document.getElementById('shuffleBtn').addEventListener('click', () => { pieces.length = Math.floor(pieces.length * 0.1); while (pieces.length < MAX_PIECES) pieces.push(createPiece(true)); });
    const colorGrid = document.getElementById('colorGrid');
    Object.keys(colorSchemes).forEach(name => {
      const btn = document.createElement('button');
      btn.className = 'color-btn' + (name === settings.colorScheme ? ' active' : '');
      btn.style.background = 'linear-gradient(135deg, ' + colorSchemes[name].slice(0, 4).join(', ') + ')';
      btn.title = name;
      btn.addEventListener('click', () => { document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); settings.colorScheme = name; });
      colorGrid.appendChild(btn);
    });
    document.addEventListener('keydown', function(e) {
      switch(e.key.toLowerCase()) {
        case ' ': e.preventDefault(); settings.isPaused = !settings.isPaused; document.getElementById('pauseBtn').textContent = settings.isPaused ? '‚ñ∂ Play' : '‚è∏ Pause'; break;
        case 'arrowleft': settings.speed = Math.max(0.05, settings.speed - 0.1); document.getElementById('speed').value = settings.speed; document.getElementById('speedVal').textContent = settings.speed.toFixed(2); break;
        case 'arrowright': settings.speed = Math.min(2, settings.speed + 0.1); document.getElementById('speed').value = settings.speed; document.getElementById('speedVal').textContent = settings.speed.toFixed(2); break;
        case 'b': settings.showBreathing = !settings.showBreathing; document.getElementById('breathingPacer').classList.toggle('visible', settings.showBreathing); break;
        case 'f': document.getElementById('fullscreenBtn').click(); break;
      }
    });
    document.getElementById('audioBtn').addEventListener('click', function() { if (settings.audioEnabled) stopAudio(); else initAudio(); });
    document.getElementById('audioSens').addEventListener('input', function() { settings.audioSensitivity = this.value / 100; document.getElementById('audioSensVal').textContent = this.value; });
    document.getElementById('binauralBtn').addEventListener('click', startBinauralTone);
    document.getElementById('binauralTrueBtn').addEventListener('click', startTrueBinaural);
    document.getElementById('toneVol').addEventListener('input', function() { settings.toneVolume = this.value / 100; document.getElementById('toneVolVal').textContent = this.value; if (binauralGain) binauralGain.gain.value = settings.toneVolume; if (binauralLeft) binauralLeft.gain.gain.value = settings.toneVolume; if (binauralRight) binauralRight.gain.gain.value = settings.toneVolume; });
    document.getElementById('audioUploadBtn').addEventListener('click', () => document.getElementById('audioUpload').click());
    document.getElementById('audioUpload').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(ev) {
          if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
          audioContext.decodeAudioData(ev.target.result, function(buffer) { uploadedAudio = buffer; document.getElementById('audioPlayBtn').style.display = 'block'; document.getElementById('audioUploadBtn').textContent = 'üìÇ ' + file.name.slice(0, 12) + '...'; });
        };
        reader.readAsArrayBuffer(file);
      }
    });
    document.getElementById('audioPlayBtn').addEventListener('click', function() {
      if (!uploadedAudio) return;
      if (uploadedSource) { uploadedSource.stop(); uploadedSource = null; this.textContent = '‚ñ∂ Play Audio'; return; }
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioContext.resume();
      uploadedSource = audioContext.createBufferSource();
      uploadedSource.buffer = uploadedAudio;
      if (!analyser) { analyser = audioContext.createAnalyser(); analyser.fftSize = 2048; audioData.raw = new Uint8Array(analyser.frequencyBinCount); }
      uploadedSource.connect(analyser);
      analyser.connect(audioContext.destination);
      uploadedSource.start();
      settings.audioEnabled = true;
      this.textContent = '‚èπ Stop Audio';
      document.getElementById('audioBtn').textContent = 'üé§ Audio (File)';
      document.getElementById('audioBtn').classList.add('active');
      uploadedSource.onended = function() { uploadedSource = null; document.getElementById('audioPlayBtn').textContent = '‚ñ∂ Play Audio'; };
    });
    
    draw();
  </script>
</body>
</html>
